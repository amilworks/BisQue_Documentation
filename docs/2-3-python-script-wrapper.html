<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="2.3 Python Script Wrapper | Getting Started" />
<meta property="og:type" content="book" />

<meta property="og:image" content="images/cover.png" />
<meta property="og:description" content="BisQue (Bio-Image Semantic Query User Environment) : Store, visualize,organize and analyze images in the cloud." />




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>

<meta name="description" content="BisQue (Bio-Image Semantic Query User Environment) : Store, visualize,organize and analyze images in the cloud.">

<title>2.3 Python Script Wrapper | Getting Started</title>

<script src="libs/header-attrs-2.1/header-attrs.js"></script>
<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link rel="stylesheet" href="style.css" type="text/css" />

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
</style>
</head>

<body>

<div class="container-fluid main-container">


<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li><a href="index.html#cloud-service-module-development-python-api">Cloud Service | Module Development | Python API</a>
<ul>
<li><a href="docker-installation.html#docker-installation"><strong>Docker Installation</strong></a>
<ul>
<li><a href="docker-installation.html#docker">Docker</a></li>
</ul></li>
</ul></li>
<li><a href="1-intro.html#intro"><span class="toc-section-number">1</span> BisQue Cloud Service</a>
<ul>
<li><a href="1-1-how-to-login-or-create-a-new-user.html#how-to-login-or-create-a-new-user"><span class="toc-section-number">1.1</span> How to Login or Create a New User</a></li>
<li><a href="1-2-how-to-upload-data.html#how-to-upload-data"><span class="toc-section-number">1.2</span> How to Upload Data</a>
<ul>
<li><a href="1-2-how-to-upload-data.html#step-1.-login">Step 1. Login</a></li>
<li><a href="1-2-how-to-upload-data.html#step-2.-upload-file-or-folder">Step 2. Upload File or Folder</a></li>
<li><a href="1-2-how-to-upload-data.html#step-3.-build-a-dataset">Step 3. Build a Dataset</a></li>
<li><a href="1-2-how-to-upload-data.html#step-4.-setting-permissions">Step 4. Setting Permissions</a></li>
</ul></li>
<li><a href="1-3-how-to-add-annotations.html#how-to-add-annotations"><span class="toc-section-number">1.3</span> How to Add Annotations</a>
<ul>
<li><a href="1-3-how-to-add-annotations.html#overview">Overview</a></li>
</ul></li>
<li><a href="1-4-how-to-run-a-module.html#how-to-run-a-module"><span class="toc-section-number">1.4</span> How to Run a Module</a></li>
<li><a href="1-5-imagej-module.html#imagej-module"><span class="toc-section-number">1.5</span> ImageJ Module</a>
<ul>
<li><a href="1-5-imagej-module.html#overview-1">Overview</a></li>
<li><a href="1-5-imagej-module.html#uploading-of-imagej-pipelines">Uploading of ImageJ Pipelines</a></li>
<li><a href="1-5-imagej-module.html#running-an-imagej-macro">Running an ImageJ Macro</a></li>
<li><a href="1-5-imagej-module.html#special-bisque-extensions-for-imagej">Special BisQue extensions for ImageJ</a></li>
</ul></li>
<li><a href="1-6-cellprofiler-module.html#cellprofiler-module"><span class="toc-section-number">1.6</span> CellProfiler Module</a>
<ul>
<li><a href="1-6-cellprofiler-module.html#overview-2">Overview</a></li>
<li><a href="1-6-cellprofiler-module.html#uploading-of-cellprofiler-pipelines">Uploading of CellProfiler Pipelines</a></li>
<li><a href="1-6-cellprofiler-module.html#running-a-cellprofiler-pipeline">Running a CellProfiler Pipeline</a></li>
<li><a href="1-6-cellprofiler-module.html#results">Results</a></li>
</ul></li>
<li><a href="1-7-plant-cell-segmentation.html#plant-cell-segmentation"><span class="toc-section-number">1.7</span> Plant Cell Segmentation</a>
<ul>
<li><a href="1-7-plant-cell-segmentation.html#overview-3">Overview</a></li>
<li><a href="1-7-plant-cell-segmentation.html#input">Input</a></li>
<li><a href="1-7-plant-cell-segmentation.html#hyperparameters">Hyperparameters</a></li>
<li><a href="1-7-plant-cell-segmentation.html#cell-features">Cell Features</a></li>
<li><a href="1-7-plant-cell-segmentation.html#output">Output</a></li>
</ul></li>
</ul></li>
<li><a href="2-module-development.html#module-development"><span class="toc-section-number">2</span> Module Development</a>
<ul>
<li><a href="2-module-development.html#how-to-begin-building-modules"><strong>How to Begin Building Modules</strong></a></li>
<li><a href="2-1-dockerfile.html#dockerfile"><span class="toc-section-number">2.1</span> Dockerfile</a>
<ul>
<li><a href="2-1-dockerfile.html#example-composite-strength"><strong>Example: Composite Strength</strong></a></li>
</ul></li>
<li><a href="2-2-module-xml.html#module-xml"><span class="toc-section-number">2.2</span> Module XML</a>
<ul>
<li><a href="2-2-module-xml.html#example"><strong>Example</strong></a></li>
<li><a href="2-2-module-xml.html#module-description">Module Description</a></li>
<li><a href="2-2-module-xml.html#configurations-for-images-datasets-and-resources">Configurations for Images, Datasets, and Resources</a></li>
<li><a href="2-2-module-xml.html#data-parallel-execution">Data-Parallel Execution</a></li>
</ul></li>
<li><a href="2-3-python-script-wrapper.html#python-script-wrapper"><span class="toc-section-number">2.3</span> Python Script Wrapper</a>
<ul>
<li><a href="2-3-python-script-wrapper.html#example.-python-script-wrapper"><em>Example.</em> Python Script Wrapper</a></li>
</ul></li>
<li><a href="2-4-source-code.html#source-code"><span class="toc-section-number">2.4</span> Source Code</a>
<ul>
<li><a href="2-4-source-code.html#example.-composite-strength-module"><em>Example.</em> Composite Strength Module</a></li>
</ul></li>
<li><a href="2-5-runtime-module-configuration.html#runtime-module-configuration"><span class="toc-section-number">2.5</span> Runtime Module Configuration</a>
<ul>
<li><a href="2-5-runtime-module-configuration.html#example.-composite-strength-module-1"><em>Example.</em> Composite Strength Module</a></li>
</ul></li>
<li><a href="2-6-python-setup.html#python-setup"><span class="toc-section-number">2.6</span> Python Setup</a></li>
</ul></li>
<li><a href="3-bqapi.html#bqapi"><span class="toc-section-number">3</span> BQAPI</a>
<ul>
<li><a href="download-an-array.html#download-an-array"><strong>Download an Array</strong></a>
<ul>
<li><a href="download-an-array.html#access-an-hdf5-table-from-bisque">Access an HDF5 Table from BisQue</a></li>
</ul></li>
</ul></li>
<li><a href="4-bisque-development.html#bisque-development"><span class="toc-section-number">4</span> BisQue Development</a>
<ul>
<li><a href="4-1-source-code-installation.html#source-code-installation"><span class="toc-section-number">4.1</span> Source Code Installation</a>
<ul>
<li><a href="4-1-source-code-installation.html#clone-the-repository-and-prepare-virtual-environment">Clone the repository and Prepare Virtual Environment</a></li>
<li><a href="4-1-source-code-installation.html#configure-bisque-environment">Configure Bisque Environment</a></li>
<li><a href="4-1-source-code-installation.html#run-bisque-server">Run Bisque Server</a></li>
<li><a href="4-1-source-code-installation.html#upload-dataset">Upload Dataset</a></li>
<li><a href="4-1-source-code-installation.html#module">Module</a></li>
<li><a href="4-1-source-code-installation.html#debug-module">Debug Module</a></li>
<li><a href="4-1-source-code-installation.html#g.-module-mexui">G. Module MEX/UI</a></li>
</ul></li>
<li><a href="4-2-planteome-deep-segment.html#planteome-deep-segment"><span class="toc-section-number">4.2</span> Planteome Deep Segment</a></li>
<li><a href="4-3-rancher-2-0-setup-wkubernetes-engine.html#rancher-2.0-setup-wkubernetes-engine"><span class="toc-section-number">4.3</span> Rancher 2.0 Setup (w/Kubernetes engine)</a>
<ul>
<li><a href="4-3-rancher-2-0-setup-wkubernetes-engine.html#pre-requisite"><span class="toc-section-number">4.3.1</span> Pre-requisite</a></li>
<li><a href="4-3-rancher-2-0-setup-wkubernetes-engine.html#setup-workload-on-the-bq-cluster"><span class="toc-section-number">4.3.2</span> Setup Workload on the bq-cluster</a></li>
</ul></li>
<li><a href="4-4-connoisseurgpu-workload-provisioning.html#connoisseurgpu-workload-provisioning"><span class="toc-section-number">4.4</span> Connoisseur/GPU Workload provisioning</a></li>
<li><a href="4-5-rancher-condor.html#rancher-condor"><span class="toc-section-number">4.5</span> Rancher Condor</a>
<ul>
<li><a href="4-5-rancher-condor.html#topology"><span class="toc-section-number">4.5.1</span> Topology</a></li>
<li><a href="4-5-rancher-condor.html#masterworker-condor-config"><span class="toc-section-number">4.5.2</span> Master/Worker Condor Config</a></li>
<li><a href="4-5-rancher-condor.html#bisquesvc-submit-node-condor-config"><span class="toc-section-number">4.5.3</span> BisqueSvc Submit Node Condor Config</a></li>
<li><a href="4-5-rancher-condor.html#state-logs"><span class="toc-section-number">4.5.4</span> State &amp; logs</a></li>
<li><a href="4-5-rancher-condor.html#test-condor"><span class="toc-section-number">4.5.5</span> Test Condor</a></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="python-script-wrapper" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Python Script Wrapper</h2>
<blockquote>
<p><strong>FILENAME: </strong> <code>PythonScriptWrapper.py</code></p>
</blockquote>
<div id="example.-python-script-wrapper" class="section level3 unnumbered" number="">
<h3><em>Example.</em> Python Script Wrapper</h3>
<div id="imports" class="section level4 unnumbered" number="">
<h4>Imports</h4>
<p>The main imports for the <code>PythonScriptWrapper</code> are mostly for logging and communicating with BisQue. In this code snippet, the line <code>from NAME_OF_MODULE import predict_function</code> is importing a prediction function from a single <code>Python</code> file. If multiple functions need to be imported from a source folder, make sure there is an <code>__init__.py</code> or there will be import errors.</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb140-1"><a href="2-3-python-script-wrapper.html#cb140-1"></a><span class="im">import</span> sys</span>
<span id="cb140-2"><a href="2-3-python-script-wrapper.html#cb140-2"></a><span class="im">import</span> io</span>
<span id="cb140-3"><a href="2-3-python-script-wrapper.html#cb140-3"></a><span class="im">from</span> lxml <span class="im">import</span> etree</span>
<span id="cb140-4"><a href="2-3-python-script-wrapper.html#cb140-4"></a><span class="im">import</span> optparse</span>
<span id="cb140-5"><a href="2-3-python-script-wrapper.html#cb140-5"></a><span class="im">import</span> logging</span>
<span id="cb140-6"><a href="2-3-python-script-wrapper.html#cb140-6"></a></span>
<span id="cb140-7"><a href="2-3-python-script-wrapper.html#cb140-7"></a></span>
<span id="cb140-8"><a href="2-3-python-script-wrapper.html#cb140-8"></a><span class="im">from</span> NAME_OF_MODULE <span class="im">import</span> predict_function</span>
<span id="cb140-9"><a href="2-3-python-script-wrapper.html#cb140-9"></a></span>
<span id="cb140-10"><a href="2-3-python-script-wrapper.html#cb140-10"></a></span>
<span id="cb140-11"><a href="2-3-python-script-wrapper.html#cb140-11"></a>logging.basicConfig(filename<span class="op">=</span><span class="st">&#39;PythonScript.log&#39;</span>,filemode<span class="op">=</span><span class="st">&#39;a&#39;</span>,level<span class="op">=</span>logging.DEBUG)</span>
<span id="cb140-12"><a href="2-3-python-script-wrapper.html#cb140-12"></a>log <span class="op">=</span> logging.getLogger(<span class="st">&#39;bq.modules&#39;</span>)</span>
<span id="cb140-13"><a href="2-3-python-script-wrapper.html#cb140-13"></a></span>
<span id="cb140-14"><a href="2-3-python-script-wrapper.html#cb140-14"></a></span>
<span id="cb140-15"><a href="2-3-python-script-wrapper.html#cb140-15"></a><span class="im">from</span> bqapi.comm <span class="im">import</span> BQCommError</span>
<span id="cb140-16"><a href="2-3-python-script-wrapper.html#cb140-16"></a><span class="im">from</span> bqapi.comm <span class="im">import</span> BQSession</span></code></pre></div>
</div>
<div id="python-script-wrapper-class" class="section level4 unnumbered" number="">
<h4>Python Script Wrapper Class</h4>
<p>The class contains all of the functions needed to initialize, run, and save the module results back to BisQue as a resource. For instance, if the output is an image, the resource would be of type image and uploaded to BisQue as an image.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb141-1"><a href="2-3-python-script-wrapper.html#cb141-1"></a><span class="kw">class</span> PythonScriptWrapper(<span class="bu">object</span>):</span>
<span id="cb141-2"><a href="2-3-python-script-wrapper.html#cb141-2"></a>    <span class="kw">def</span> run(<span class="va">self</span>):</span>
<span id="cb141-3"><a href="2-3-python-script-wrapper.html#cb141-3"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb141-4"><a href="2-3-python-script-wrapper.html#cb141-4"></a><span class="co">        Run Python script</span></span>
<span id="cb141-5"><a href="2-3-python-script-wrapper.html#cb141-5"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb141-6"><a href="2-3-python-script-wrapper.html#cb141-6"></a>        bq <span class="op">=</span> <span class="va">self</span>.bqSession</span>
<span id="cb141-7"><a href="2-3-python-script-wrapper.html#cb141-7"></a>        </span>
<span id="cb141-8"><a href="2-3-python-script-wrapper.html#cb141-8"></a>        <span class="co"># call script</span></span>
<span id="cb141-9"><a href="2-3-python-script-wrapper.html#cb141-9"></a>        outputs <span class="op">=</span> predict_function( bq, log, <span class="op">**</span><span class="va">self</span>.options.__dict__ )</span>
<span id="cb141-10"><a href="2-3-python-script-wrapper.html#cb141-10"></a>        </span>
<span id="cb141-11"><a href="2-3-python-script-wrapper.html#cb141-11"></a>        <span class="co"># save output back to BisQue</span></span>
<span id="cb141-12"><a href="2-3-python-script-wrapper.html#cb141-12"></a>        <span class="cf">for</span> output <span class="kw">in</span> outputs:</span>
<span id="cb141-13"><a href="2-3-python-script-wrapper.html#cb141-13"></a>            <span class="va">self</span>.output_resources.append(output)</span>
<span id="cb141-14"><a href="2-3-python-script-wrapper.html#cb141-14"></a>    </span>
<span id="cb141-15"><a href="2-3-python-script-wrapper.html#cb141-15"></a>    <span class="kw">def</span> setup(<span class="va">self</span>):</span>
<span id="cb141-16"><a href="2-3-python-script-wrapper.html#cb141-16"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb141-17"><a href="2-3-python-script-wrapper.html#cb141-17"></a><span class="co">        Pre-run initialization</span></span>
<span id="cb141-18"><a href="2-3-python-script-wrapper.html#cb141-18"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb141-19"><a href="2-3-python-script-wrapper.html#cb141-19"></a>        <span class="va">self</span>.bqSession.update_mex(<span class="st">&#39;Initializing...&#39;</span>)</span>
<span id="cb141-20"><a href="2-3-python-script-wrapper.html#cb141-20"></a>        <span class="va">self</span>.mex_parameter_parser(<span class="va">self</span>.bqSession.mex.xmltree)</span>
<span id="cb141-21"><a href="2-3-python-script-wrapper.html#cb141-21"></a>        <span class="va">self</span>.output_resources <span class="op">=</span> []</span>
<span id="cb141-22"><a href="2-3-python-script-wrapper.html#cb141-22"></a></span>
<span id="cb141-23"><a href="2-3-python-script-wrapper.html#cb141-23"></a>    <span class="kw">def</span> teardown(<span class="va">self</span>):</span>
<span id="cb141-24"><a href="2-3-python-script-wrapper.html#cb141-24"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb141-25"><a href="2-3-python-script-wrapper.html#cb141-25"></a><span class="co">        Post the results to the mex xml</span></span>
<span id="cb141-26"><a href="2-3-python-script-wrapper.html#cb141-26"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb141-27"><a href="2-3-python-script-wrapper.html#cb141-27"></a>        <span class="va">self</span>.bqSession.update_mex( <span class="st">&#39;Returning results&#39;</span>)</span>
<span id="cb141-28"><a href="2-3-python-script-wrapper.html#cb141-28"></a></span>
<span id="cb141-29"><a href="2-3-python-script-wrapper.html#cb141-29"></a>        outputTag <span class="op">=</span> etree.Element(<span class="st">&#39;tag&#39;</span>, name <span class="op">=</span><span class="st">&#39;outputs&#39;</span>)</span>
<span id="cb141-30"><a href="2-3-python-script-wrapper.html#cb141-30"></a>        <span class="cf">for</span> r_xml <span class="kw">in</span> <span class="va">self</span>.output_resources:</span>
<span id="cb141-31"><a href="2-3-python-script-wrapper.html#cb141-31"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(r_xml, <span class="bu">basestring</span>):</span>
<span id="cb141-32"><a href="2-3-python-script-wrapper.html#cb141-32"></a>                r_xml <span class="op">=</span> etree.fromstring(r_xml) </span>
<span id="cb141-33"><a href="2-3-python-script-wrapper.html#cb141-33"></a>            res_type <span class="op">=</span> r_xml.get(<span class="st">&#39;type&#39;</span>, <span class="va">None</span>) <span class="kw">or</span> r_xml.get(<span class="st">&#39;resource_type&#39;</span>, <span class="va">None</span>) <span class="kw">or</span> r_xml.tag</span>
<span id="cb141-34"><a href="2-3-python-script-wrapper.html#cb141-34"></a>            <span class="co"># append reference to output</span></span>
<span id="cb141-35"><a href="2-3-python-script-wrapper.html#cb141-35"></a>            <span class="cf">if</span> res_type <span class="kw">in</span> [<span class="st">&#39;table&#39;</span>, <span class="st">&#39;image&#39;</span>]:</span>
<span id="cb141-36"><a href="2-3-python-script-wrapper.html#cb141-36"></a>                outputTag.append(r_xml)</span>
<span id="cb141-37"><a href="2-3-python-script-wrapper.html#cb141-37"></a>                <span class="co">#etree.SubElement(outputTag, &#39;tag&#39;, name=&#39;output_table&#39; if res_type==&#39;table&#39; else &#39;output_image&#39;, type=res_type, value=r_xml.get(&#39;uri&#39;,&#39;&#39;))</span></span>
<span id="cb141-38"><a href="2-3-python-script-wrapper.html#cb141-38"></a>            <span class="cf">else</span>:</span>
<span id="cb141-39"><a href="2-3-python-script-wrapper.html#cb141-39"></a>                outputTag.append(r_xml)</span>
<span id="cb141-40"><a href="2-3-python-script-wrapper.html#cb141-40"></a>                <span class="co">#etree.SubElement(outputTag, r_xml.tag, name=r_xml.get(&#39;name&#39;, &#39;_&#39;), type=r_xml.get(&#39;type&#39;, &#39;string&#39;), value=r_xml.get(&#39;value&#39;, &#39;&#39;))</span></span>
<span id="cb141-41"><a href="2-3-python-script-wrapper.html#cb141-41"></a>        <span class="va">self</span>.bqSession.finish_mex(tags<span class="op">=</span>[outputTag])</span>
<span id="cb141-42"><a href="2-3-python-script-wrapper.html#cb141-42"></a></span>
<span id="cb141-43"><a href="2-3-python-script-wrapper.html#cb141-43"></a>    <span class="kw">def</span> mex_parameter_parser(<span class="va">self</span>, mex_xml):</span>
<span id="cb141-44"><a href="2-3-python-script-wrapper.html#cb141-44"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb141-45"><a href="2-3-python-script-wrapper.html#cb141-45"></a><span class="co">            Parses input of the xml and add it to options attribute (unless already set)</span></span>
<span id="cb141-46"><a href="2-3-python-script-wrapper.html#cb141-46"></a></span>
<span id="cb141-47"><a href="2-3-python-script-wrapper.html#cb141-47"></a><span class="co">            @param: mex_xml</span></span>
<span id="cb141-48"><a href="2-3-python-script-wrapper.html#cb141-48"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb141-49"><a href="2-3-python-script-wrapper.html#cb141-49"></a>        <span class="co"># inputs are all non-&quot;script_params&quot; under &quot;inputs&quot; and all params under &quot;script_params&quot;</span></span>
<span id="cb141-50"><a href="2-3-python-script-wrapper.html#cb141-50"></a>        mex_inputs <span class="op">=</span> mex_xml.xpath(<span class="st">&#39;tag[@name=&quot;inputs&quot;]/tag[@name!=&quot;script_params&quot;] | tag[@name=&quot;inputs&quot;]/tag[@name=&quot;script_params&quot;]/tag&#39;</span>)</span>
<span id="cb141-51"><a href="2-3-python-script-wrapper.html#cb141-51"></a>        <span class="cf">if</span> mex_inputs:</span>
<span id="cb141-52"><a href="2-3-python-script-wrapper.html#cb141-52"></a>            <span class="cf">for</span> tag <span class="kw">in</span> mex_inputs:</span>
<span id="cb141-53"><a href="2-3-python-script-wrapper.html#cb141-53"></a>                <span class="cf">if</span> tag.tag <span class="op">==</span> <span class="st">&#39;tag&#39;</span> <span class="kw">and</span> tag.get(<span class="st">&#39;type&#39;</span>, <span class="st">&#39;&#39;</span>) <span class="op">!=</span> <span class="st">&#39;system-input&#39;</span>: <span class="co">#skip system input values</span></span>
<span id="cb141-54"><a href="2-3-python-script-wrapper.html#cb141-54"></a>                    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">getattr</span>(<span class="va">self</span>.options,tag.get(<span class="st">&#39;name&#39;</span>, <span class="st">&#39;&#39;</span>), <span class="va">None</span>):</span>
<span id="cb141-55"><a href="2-3-python-script-wrapper.html#cb141-55"></a>                        log.debug(<span class="st">&#39;Set options with </span><span class="sc">%s</span><span class="st"> as </span><span class="sc">%s</span><span class="st">&#39;</span><span class="op">%</span>(tag.get(<span class="st">&#39;name&#39;</span>,<span class="st">&#39;&#39;</span>),tag.get(<span class="st">&#39;value&#39;</span>,<span class="st">&#39;&#39;</span>)))</span>
<span id="cb141-56"><a href="2-3-python-script-wrapper.html#cb141-56"></a>                        <span class="bu">setattr</span>(<span class="va">self</span>.options,tag.get(<span class="st">&#39;name&#39;</span>,<span class="st">&#39;&#39;</span>),tag.get(<span class="st">&#39;value&#39;</span>,<span class="st">&#39;&#39;</span>))</span>
<span id="cb141-57"><a href="2-3-python-script-wrapper.html#cb141-57"></a>        <span class="cf">else</span>:</span>
<span id="cb141-58"><a href="2-3-python-script-wrapper.html#cb141-58"></a>            log.debug(<span class="st">&#39;No Inputs Found on MEX!&#39;</span>)</span>
<span id="cb141-59"><a href="2-3-python-script-wrapper.html#cb141-59"></a></span>
<span id="cb141-60"><a href="2-3-python-script-wrapper.html#cb141-60"></a>    <span class="kw">def</span> validate_input(<span class="va">self</span>):</span>
<span id="cb141-61"><a href="2-3-python-script-wrapper.html#cb141-61"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb141-62"><a href="2-3-python-script-wrapper.html#cb141-62"></a><span class="co">            Check to see if a mex with token or user with password was provided.</span></span>
<span id="cb141-63"><a href="2-3-python-script-wrapper.html#cb141-63"></a></span>
<span id="cb141-64"><a href="2-3-python-script-wrapper.html#cb141-64"></a><span class="co">            @return True is returned if validation credention was provided else</span></span>
<span id="cb141-65"><a href="2-3-python-script-wrapper.html#cb141-65"></a><span class="co">            False is returned</span></span>
<span id="cb141-66"><a href="2-3-python-script-wrapper.html#cb141-66"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb141-67"><a href="2-3-python-script-wrapper.html#cb141-67"></a>        <span class="cf">if</span> (<span class="va">self</span>.options.mexURL <span class="kw">and</span> <span class="va">self</span>.options.token): <span class="co">#run module through engine service</span></span>
<span id="cb141-68"><a href="2-3-python-script-wrapper.html#cb141-68"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb141-69"><a href="2-3-python-script-wrapper.html#cb141-69"></a></span>
<span id="cb141-70"><a href="2-3-python-script-wrapper.html#cb141-70"></a>        <span class="cf">if</span> (<span class="va">self</span>.options.user <span class="kw">and</span> <span class="va">self</span>.options.pwd <span class="kw">and</span> <span class="va">self</span>.options.root): <span class="co">#run module locally (note: to test module)</span></span>
<span id="cb141-71"><a href="2-3-python-script-wrapper.html#cb141-71"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb141-72"><a href="2-3-python-script-wrapper.html#cb141-72"></a></span>
<span id="cb141-73"><a href="2-3-python-script-wrapper.html#cb141-73"></a>        log.debug(<span class="st">&#39;Insufficient options or arguments to start this module&#39;</span>)</span>
<span id="cb141-74"><a href="2-3-python-script-wrapper.html#cb141-74"></a>        <span class="cf">return</span> <span class="va">False</span></span></code></pre></div>
</div>
<div id="main-function" class="section level4 unnumbered" number="">
<h4>Main Function</h4>
<p>The main function enables the communication between BisQue and the module. For example, when a module is run under a user, we need to make sure that the unique ID is registered with the user.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb142-1"><a href="2-3-python-script-wrapper.html#cb142-1"></a><span class="kw">def</span> main(<span class="va">self</span>):</span>
<span id="cb142-2"><a href="2-3-python-script-wrapper.html#cb142-2"></a>    parser <span class="op">=</span> optparse.OptionParser()</span>
<span id="cb142-3"><a href="2-3-python-script-wrapper.html#cb142-3"></a>    parser.add_option(<span class="st">&#39;--mex_url&#39;</span>         , dest<span class="op">=</span><span class="st">&quot;mexURL&quot;</span>)</span>
<span id="cb142-4"><a href="2-3-python-script-wrapper.html#cb142-4"></a>    parser.add_option(<span class="st">&#39;--module_dir&#39;</span>      , dest<span class="op">=</span><span class="st">&quot;modulePath&quot;</span>)</span>
<span id="cb142-5"><a href="2-3-python-script-wrapper.html#cb142-5"></a>    parser.add_option(<span class="st">&#39;--staging_path&#39;</span>    , dest<span class="op">=</span><span class="st">&quot;stagingPath&quot;</span>)</span>
<span id="cb142-6"><a href="2-3-python-script-wrapper.html#cb142-6"></a>    parser.add_option(<span class="st">&#39;--bisque_token&#39;</span>    , dest<span class="op">=</span><span class="st">&quot;token&quot;</span>)</span>
<span id="cb142-7"><a href="2-3-python-script-wrapper.html#cb142-7"></a>    parser.add_option(<span class="st">&#39;--user&#39;</span>            , dest<span class="op">=</span><span class="st">&quot;user&quot;</span>)</span>
<span id="cb142-8"><a href="2-3-python-script-wrapper.html#cb142-8"></a>    parser.add_option(<span class="st">&#39;--pwd&#39;</span>             , dest<span class="op">=</span><span class="st">&quot;pwd&quot;</span>)</span>
<span id="cb142-9"><a href="2-3-python-script-wrapper.html#cb142-9"></a>    parser.add_option(<span class="st">&#39;--root&#39;</span>            , dest<span class="op">=</span><span class="st">&quot;root&quot;</span>)</span>
<span id="cb142-10"><a href="2-3-python-script-wrapper.html#cb142-10"></a>        </span>
<span id="cb142-11"><a href="2-3-python-script-wrapper.html#cb142-11"></a>    (options, args) <span class="op">=</span> parser.parse_args()</span>
<span id="cb142-12"><a href="2-3-python-script-wrapper.html#cb142-12"></a></span>
<span id="cb142-13"><a href="2-3-python-script-wrapper.html#cb142-13"></a>    fh <span class="op">=</span> logging.FileHandler(<span class="st">&#39;scriptrun.log&#39;</span>, mode<span class="op">=</span><span class="st">&#39;a&#39;</span>)</span>
<span id="cb142-14"><a href="2-3-python-script-wrapper.html#cb142-14"></a>    fh.setLevel(logging.DEBUG)</span>
<span id="cb142-15"><a href="2-3-python-script-wrapper.html#cb142-15"></a>    formatter <span class="op">=</span> logging.Formatter(<span class="st">&#39;[</span><span class="sc">%(asctime)s</span><span class="st">] </span><span class="sc">%(levelname)8s</span><span class="st"> --- </span><span class="sc">%(message)s</span><span class="st"> &#39;</span> <span class="op">+</span></span>
<span id="cb142-16"><a href="2-3-python-script-wrapper.html#cb142-16"></a>                              <span class="st">&#39;(</span><span class="sc">%(filename)s</span><span class="st">:</span><span class="sc">%(lineno)s</span><span class="st">)&#39;</span>,datefmt<span class="op">=</span><span class="st">&#39;%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S&#39;</span>)</span>
<span id="cb142-17"><a href="2-3-python-script-wrapper.html#cb142-17"></a>    fh.setFormatter(formatter)</span>
<span id="cb142-18"><a href="2-3-python-script-wrapper.html#cb142-18"></a>    log.addHandler(fh)</span>
<span id="cb142-19"><a href="2-3-python-script-wrapper.html#cb142-19"></a></span>
<span id="cb142-20"><a href="2-3-python-script-wrapper.html#cb142-20"></a>    <span class="cf">try</span>: <span class="co">#pull out the mex</span></span>
<span id="cb142-21"><a href="2-3-python-script-wrapper.html#cb142-21"></a></span>
<span id="cb142-22"><a href="2-3-python-script-wrapper.html#cb142-22"></a>        <span class="cf">if</span> <span class="kw">not</span> options.mexURL:</span>
<span id="cb142-23"><a href="2-3-python-script-wrapper.html#cb142-23"></a>            options.mexURL <span class="op">=</span> sys.argv[<span class="op">-</span><span class="dv">2</span>]</span>
<span id="cb142-24"><a href="2-3-python-script-wrapper.html#cb142-24"></a>        <span class="cf">if</span> <span class="kw">not</span> options.token:</span>
<span id="cb142-25"><a href="2-3-python-script-wrapper.html#cb142-25"></a>            options.token <span class="op">=</span> sys.argv[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb142-26"><a href="2-3-python-script-wrapper.html#cb142-26"></a></span>
<span id="cb142-27"><a href="2-3-python-script-wrapper.html#cb142-27"></a>    <span class="cf">except</span> <span class="pp">IndexError</span>: <span class="co">#no argv were set</span></span>
<span id="cb142-28"><a href="2-3-python-script-wrapper.html#cb142-28"></a>        <span class="cf">pass</span></span>
<span id="cb142-29"><a href="2-3-python-script-wrapper.html#cb142-29"></a></span>
<span id="cb142-30"><a href="2-3-python-script-wrapper.html#cb142-30"></a>    <span class="cf">if</span> <span class="kw">not</span> options.stagingPath:</span>
<span id="cb142-31"><a href="2-3-python-script-wrapper.html#cb142-31"></a>        options.stagingPath <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb142-32"><a href="2-3-python-script-wrapper.html#cb142-32"></a></span>
<span id="cb142-33"><a href="2-3-python-script-wrapper.html#cb142-33"></a>    log.info(<span class="st">&#39;</span><span class="ch">\n\n</span><span class="st">PARAMS : </span><span class="sc">%s</span><span class="st"> </span><span class="ch">\n\n</span><span class="st"> Options: </span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> (args, options))</span>
<span id="cb142-34"><a href="2-3-python-script-wrapper.html#cb142-34"></a>    <span class="va">self</span>.options <span class="op">=</span> options</span>
<span id="cb142-35"><a href="2-3-python-script-wrapper.html#cb142-35"></a></span>
<span id="cb142-36"><a href="2-3-python-script-wrapper.html#cb142-36"></a>    <span class="cf">if</span> <span class="va">self</span>.validate_input():</span>
<span id="cb142-37"><a href="2-3-python-script-wrapper.html#cb142-37"></a></span>
<span id="cb142-38"><a href="2-3-python-script-wrapper.html#cb142-38"></a>        <span class="co">#initalizes if user and password are provided</span></span>
<span id="cb142-39"><a href="2-3-python-script-wrapper.html#cb142-39"></a>        <span class="cf">if</span> (<span class="va">self</span>.options.user <span class="kw">and</span> <span class="va">self</span>.options.pwd <span class="kw">and</span> <span class="va">self</span>.options.root):</span>
<span id="cb142-40"><a href="2-3-python-script-wrapper.html#cb142-40"></a>            <span class="va">self</span>.bqSession <span class="op">=</span> BQSession().init_local( <span class="va">self</span>.options.user, <span class="va">self</span>.options.pwd, bisque_root<span class="op">=</span><span class="va">self</span>.options.root)</span>
<span id="cb142-41"><a href="2-3-python-script-wrapper.html#cb142-41"></a>            <span class="va">self</span>.options.mexURL <span class="op">=</span> <span class="va">self</span>.bqSession.mex.uri</span>
<span id="cb142-42"><a href="2-3-python-script-wrapper.html#cb142-42"></a></span>
<span id="cb142-43"><a href="2-3-python-script-wrapper.html#cb142-43"></a>        <span class="co">#initalizes if mex and mex token is provided</span></span>
<span id="cb142-44"><a href="2-3-python-script-wrapper.html#cb142-44"></a>        <span class="cf">elif</span> (<span class="va">self</span>.options.mexURL <span class="kw">and</span> <span class="va">self</span>.options.token):</span>
<span id="cb142-45"><a href="2-3-python-script-wrapper.html#cb142-45"></a>            <span class="va">self</span>.bqSession <span class="op">=</span> BQSession().init_mex(<span class="va">self</span>.options.mexURL, <span class="va">self</span>.options.token)</span>
<span id="cb142-46"><a href="2-3-python-script-wrapper.html#cb142-46"></a></span>
<span id="cb142-47"><a href="2-3-python-script-wrapper.html#cb142-47"></a>        <span class="cf">else</span>:</span>
<span id="cb142-48"><a href="2-3-python-script-wrapper.html#cb142-48"></a>            <span class="cf">raise</span> ScriptError(<span class="st">&#39;Insufficient options or arguments to start this module&#39;</span>)</span>
<span id="cb142-49"><a href="2-3-python-script-wrapper.html#cb142-49"></a></span>
<span id="cb142-50"><a href="2-3-python-script-wrapper.html#cb142-50"></a>        <span class="cf">try</span>:</span>
<span id="cb142-51"><a href="2-3-python-script-wrapper.html#cb142-51"></a>            <span class="va">self</span>.setup()</span>
<span id="cb142-52"><a href="2-3-python-script-wrapper.html#cb142-52"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb142-53"><a href="2-3-python-script-wrapper.html#cb142-53"></a>            log.exception(<span class="st">&quot;Exception during setup&quot;</span>)</span>
<span id="cb142-54"><a href="2-3-python-script-wrapper.html#cb142-54"></a>            <span class="va">self</span>.bqSession.fail_mex(msg <span class="op">=</span> <span class="st">&quot;Exception during setup: </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span>  <span class="bu">str</span>(e))</span>
<span id="cb142-55"><a href="2-3-python-script-wrapper.html#cb142-55"></a>            <span class="cf">return</span></span>
<span id="cb142-56"><a href="2-3-python-script-wrapper.html#cb142-56"></a></span>
<span id="cb142-57"><a href="2-3-python-script-wrapper.html#cb142-57"></a>        <span class="cf">try</span>:</span>
<span id="cb142-58"><a href="2-3-python-script-wrapper.html#cb142-58"></a>            <span class="va">self</span>.run()</span>
<span id="cb142-59"><a href="2-3-python-script-wrapper.html#cb142-59"></a>        <span class="cf">except</span> (<span class="pp">Exception</span>, ScriptError) <span class="im">as</span> e:</span>
<span id="cb142-60"><a href="2-3-python-script-wrapper.html#cb142-60"></a>            log.exception(<span class="st">&quot;Exception during run&quot;</span>)</span>
<span id="cb142-61"><a href="2-3-python-script-wrapper.html#cb142-61"></a>            <span class="va">self</span>.bqSession.fail_mex(msg <span class="op">=</span> <span class="st">&quot;Exception during run: </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> <span class="bu">str</span>(e))</span>
<span id="cb142-62"><a href="2-3-python-script-wrapper.html#cb142-62"></a>            <span class="cf">return</span></span>
<span id="cb142-63"><a href="2-3-python-script-wrapper.html#cb142-63"></a></span>
<span id="cb142-64"><a href="2-3-python-script-wrapper.html#cb142-64"></a>        <span class="cf">try</span>:</span>
<span id="cb142-65"><a href="2-3-python-script-wrapper.html#cb142-65"></a>            <span class="va">self</span>.teardown()</span>
<span id="cb142-66"><a href="2-3-python-script-wrapper.html#cb142-66"></a>        <span class="cf">except</span> (<span class="pp">Exception</span>, ScriptError) <span class="im">as</span> e:</span>
<span id="cb142-67"><a href="2-3-python-script-wrapper.html#cb142-67"></a>            log.exception(<span class="st">&quot;Exception during teardown&quot;</span>)</span>
<span id="cb142-68"><a href="2-3-python-script-wrapper.html#cb142-68"></a>            <span class="va">self</span>.bqSession.fail_mex(msg <span class="op">=</span> <span class="st">&quot;Exception during teardown: </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span>  <span class="bu">str</span>(e))</span>
<span id="cb142-69"><a href="2-3-python-script-wrapper.html#cb142-69"></a>            <span class="cf">return</span></span>
<span id="cb142-70"><a href="2-3-python-script-wrapper.html#cb142-70"></a>    </span>
<span id="cb142-71"><a href="2-3-python-script-wrapper.html#cb142-71"></a>        <span class="va">self</span>.bqSession.close()</span>
<span id="cb142-72"><a href="2-3-python-script-wrapper.html#cb142-72"></a></span>
<span id="cb142-73"><a href="2-3-python-script-wrapper.html#cb142-73"></a><span class="cf">if</span> <span class="va">__name__</span><span class="op">==</span><span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb142-74"><a href="2-3-python-script-wrapper.html#cb142-74"></a>    PythonScriptWrapper().main()</span></code></pre></div>
</div>
</div>
</div>
<p style="text-align: center;">
<a href="2-2-module-xml.html"><button class="btn btn-default">Previous</button></a>
<a href="2-4-source-code.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>
